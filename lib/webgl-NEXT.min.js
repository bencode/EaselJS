/*!
* @license EaselJS
* Visit http://createjs.com/ for documentation, updates and examples.
*
* Copyright (c) 2011-2015 gskinner.com, inc.
*
* Distributed under the terms of the MIT license.
* http://www.opensource.org/licenses/mit-license.html
*
* This notice shall be included in all copies or substantial portions of the Software.
*/
this.createjs=this.createjs||{},function(){"use strict";function a(b,c,d,e){this.Stage_constructor(b),this.vocalDebug=!1,this._preserveDrawingBuffer=c||!1,this._antialias=d||!1,this._transparent=e||!1,this._viewportWidth=0,this._viewportHeight=0,this._projectionMatrix=null,this._webGLContext=null,this._clearColor={r:0,g:0,b:0,a:0},this._maxCardsPerBatch=a.DEFAULT_MAX_BATCH_SIZE,this._activeShader=null,this._vertices=null,this._vertexPositionBuffer=null,this._uvs=null,this._uvPositionBuffer=null,this._indecies=null,this._textureIndexBuffer=null,this._alphas=null,this._alphaBuffer=null,this._textureDictionary=[],this._textureIDs={},this._batchTextures=[],this._batchTextureCount=8,this._lastTextureInsert=-1,this._lastTextureID=-1,this._batchID=0,this._drawID=0,this._slotBlacklist=[],this._isDrawing=0,this._lastTrackedCanvas=0,this.isCacheControlled=!1,this._cacheContainer=new createjs.Container,this._initializeWebGL()}var b=createjs.extend(a,createjs.Stage);a.buildUVRects=function(a,b,c){if(!a||!a._frames)return null;void 0===b&&(b=-1),void 0===c&&(c=!1);for(var d=-1!=b&&c?b:0,e=-1!=b&&c?b+1:a._frames.length,f=d;e>f;f++){var g=a._frames[f];if(!g.uvRect&&!(g.image.width<=0||g.image.height<=0)){var h=g.rect;g.uvRect={t:h.y/g.image.height,l:h.x/g.image.width,b:(h.y+h.height)/g.image.height,r:(h.x+h.width)/g.image.width}}}return a._frames[-1!=b?b:0].uvRect||{t:0,l:0,b:1,r:1}},a.isWebGLActive=function(a){return a&&a instanceof WebGLRenderingContext&&"undefined"!=typeof WebGLRenderingContext},a.VERTEX_PROPERTY_COUNT=6,a.INDICIES_PER_CARD=6,a.DEFAULT_MAX_BATCH_SIZE=8e3,a.WEBGL_MAX_INDEX_NUM=Math.pow(2,16),a.UV_RECT={t:0,l:0,b:1,r:1},a.COVER_VERT=new Float32Array([-1,1,1,1,-1,-1,1,1,1,-1,-1,-1]),a.COVER_UV=new Float32Array([0,0,1,0,0,1,1,0,1,1,0,1]),a.COVER_UV_FLIP=new Float32Array([0,1,1,1,0,0,1,1,1,0,0,0]),a.REGULAR_VARYING_HEADER="precision mediump float;varying vec2 vTextureCoord;varying lowp float indexPicker;varying lowp float alphaValue;",a.REGULAR_VERTEX_HEADER=a.REGULAR_VARYING_HEADER+"attribute vec2 vertexPosition;attribute vec2 uvPosition;attribute lowp float textureIndex;attribute lowp float objectAlpha;uniform mat4 pMatrix;",a.REGULAR_FRAGMENT_HEADER=a.REGULAR_VARYING_HEADER+"uniform sampler2D uSampler[{{count}}];",a.REGULAR_VERTEX_BODY="void main(void) {gl_Position = vec4((vertexPosition.x * pMatrix[0][0]) + pMatrix[3][0],(vertexPosition.y * pMatrix[1][1]) + pMatrix[3][1],pMatrix[3][2],1.0);alphaValue = objectAlpha;indexPicker = textureIndex;vTextureCoord = uvPosition;}",a.REGULAR_FRAGMENT_BODY="void main(void) {int src = int(indexPicker);vec4 color = vec4(1.0, 0.0, 0.0, 1.0);if(src == 0) {color = texture2D(uSampler[0], vTextureCoord);{{alternates}}}gl_FragColor = vec4(color.rgb, color.a * alphaValue);}",a.PARTICLE_VERTEX_BODY=a.REGULAR_VERTEX_BODY,a.PARTICLE_FRAGMENT_BODY=a.REGULAR_FRAGMENT_BODY,a.COVER_VARYING_HEADER="precision mediump float;varying highp vec2 vRenderCoord;varying highp vec2 vTextureCoord;",a.COVER_VERTEX_HEADER=a.COVER_VARYING_HEADER+"attribute vec2 vertexPosition;attribute vec2 uvPosition;uniform float uUpright;",a.COVER_FRAGMENT_HEADER=a.COVER_VARYING_HEADER+"uniform sampler2D uSampler;",a.COVER_VERTEX_BODY="void main(void) {gl_Position = vec4(vertexPosition.x, vertexPosition.y, 0.0, 1.0);vRenderCoord = uvPosition;vTextureCoord = vec2(uvPosition.x, abs(uUpright - uvPosition.y));}",a.COVER_FRAGMENT_BODY="void main(void) {vec4 color = texture2D(uSampler, vRenderCoord);gl_FragColor = color;}",b._get_isWebGL=function(){return!!this._webGLContext},b._get_contextWebGL=function(){return this._webGLContext};try{Object.defineProperties(b,{isWebGL:{get:b._get_isWebGL}})}catch(c){}b._initializeWebGL=function(){if(this.canvas){if(!this._webGLContext||this._webGLContext.canvas!==this.canvas){var a={depth:!1,alpha:this._transparent,stencil:!0,antialias:this._antialias,preserveDrawingBuffer:this._preserveDrawingBuffer,premultipliedAlpha:!0},b=this._webGLContext=this._fetchWebGLContext(this.canvas,a);this.updateSimultaneousTextureCount(b.getParameter(b.MAX_TEXTURE_IMAGE_UNITS)),this._createBuffers(b),this._initTextures(b),b.clearColor(.25,.25,.25,0),b.disable(b.DEPTH_TEST),b.enable(b.BLEND),b.blendFuncSeparate(b.SRC_ALPHA,b.ONE_MINUS_SRC_ALPHA,b.ONE,b.ONE_MINUS_SRC_ALPHA),b.pixelStorei(b.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),this.updateViewport(this._viewportWidth||this.canvas.width,this._viewportHeight||this.canvas.height)}}else this._webGLContext=null;return this._webGLContext},b.update=function(a){if(this.canvas){if(this.tickOnUpdate&&this.tick(a),this.dispatchEvent("drawstart"),this.autoClear&&this.clear(),this._webGLContext)this._batchDraw(this,this._webGLContext);else{var b=this.canvas.getContext("2d");b.save(),this.updateContext(b),this.draw(b,!1),b.restore()}this.dispatchEvent("drawend")}},b.clear=function(){if(this.canvas)if(a.isWebGLActive(this._webGLContext)){var b=this._webGLContext;b.clear(b.COLOR_BUFFER_BIT)}else{var c=this.canvas.getContext("2d");c.setTransform(1,0,0,1,0,0),c.clearRect(0,0,this.canvas.width+1,this.canvas.height+1)}},b.draw=function(b,c){if(aaaaaaaaaaaaaaaaaaaaaaaaaaaa,a.isWebGLActive(this._webGLContext)){var d=this._webGLContext;return this._batchDraw(this,d,c),!0}return this.Stage_draw(b,c)},b.cacheDraw=function(a,b){var c,d=this._webGLContext,e=this._activeShader,f=this._slotBlacklist,g=this._batchTextureCount-1;this.protectTextureSlot(g,!0);var h=a.getMatrix();h=h.clone().invert();var i=this._cacheContainer;i.children=[a],i.transformMatrix=h;for(var j=0;j<this._batchTextureCount;j++)d.activeTexture(d.TEXTURE0+j),this._batchTextures[j]=this.getBaseTexture();var k=b&&b.length;if(k){d.activeTexture(d.TEXTURE0+g),c=this.getTargetRenderTexture(d,a),d.bindFramebuffer(d.FRAMEBUFFER,c._frameBuffer),d.clear(d.COLOR_BUFFER_BIT),this._batchDraw(i,d,!0),d.activeTexture(d.TEXTURE0),d.bindTexture(d.TEXTURE_2D,c),this.setTextureParams(d);for(var l=!1,m=0;k>m;m++){var n=b[m];d.activeTexture(d.TEXTURE0+g),c=this.getTargetRenderTexture(d,a),d.bindFramebuffer(d.FRAMEBUFFER,c._frameBuffer),this._activeShader=this.getFilterShader(d,n),this._activeShader&&(this._drawCover(d,l),d.activeTexture(d.TEXTURE0),d.bindTexture(d.TEXTURE_2D,c),this.setTextureParams(d),k>1&&(l=!l))}this.isCacheControlled?(d.bindFramebuffer(d.FRAMEBUFFER,null),this._activeShader=this.getFilterShader(d,this),this._drawCover(d,l)):(l&&(d.activeTexture(d.TEXTURE0+g),c=this.getTargetRenderTexture(d,a),d.bindFramebuffer(d.FRAMEBUFFER,c._frameBuffer),this._activeShader=this.getFilterShader(d,this),this._drawCover(d,!l)),d.bindFramebuffer(d.FRAMEBUFFER,null),a.cacheCanvas=c)}else if(this.isCacheControlled)d.clear(d.COLOR_BUFFER_BIT),this._batchDraw(i,d,!0);else{d.activeTexture(d.TEXTURE0+g),a.cacheCanvas=this.getTargetRenderTexture(d,a),c=a.cacheCanvas,d.bindFramebuffer(d.FRAMEBUFFER,c._frameBuffer);var o=this._projectionMatrix;this._projectionMatrix=this._projectionMatrixFlip,d.clear(d.COLOR_BUFFER_BIT),this._batchDraw(i,d,!0),d.bindFramebuffer(d.FRAMEBUFFER,null),this._projectionMatrix=o}this.protectTextureSlot(g,!1),this._activeShader=e,this._slotBlacklist=f},b.protectTextureSlot=function(a,b){if(a>this._batchTextureCount||0>a)throw"Slot outside of acceptable range";this._slotBlacklist[a]=!!b},b.getTargetRenderTexture=function(a,b){var c,d=!1;return void 0!==b.__lastRT&&b.__lastRT===b.__rtA&&(d=!0),d?(void 0===b.__rtB?b.__rtB=this.getRenderBufferTexture(b._cacheWidth,b._cacheHeight):(a.bindTexture(a.TEXTURE_2D,b.__rtB),this.setTextureParams(a)),c=b.__rtB):(void 0===b.__rtA?b.__rtA=this.getRenderBufferTexture(b._cacheWidth,b._cacheHeight):(a.bindTexture(a.TEXTURE_2D,b.__rtA),this.setTextureParams(a)),c=b.__rtA),b.__lastRT=c,c},b.unregisterTexture=function(a){if(a.children)for(var b=0,c=a.children.length;c>b;b++)this.unregisterTexture(a.children);if(!(a._storeID<0)){var d;if(void 0!==a._storeID?d=a:1===a._webGLRenderStyle?d=a.spriteSheet.getFrame(a.currentFrame).image:2===a._webGLRenderStyle&&(d=a.cacheCanvas?a.cacheCanvas:a.image),void 0===d)return void(vocalDebug&&console.log("No associated texture found on release"));this._textureIDs[d.src]=void 0,this._textureDictionary[d._storeID]=void 0}},b.updateSimultaneousTextureCount=function(a){var b=this._webGLContext,c=!1;for(this._batchTextureCount=a,this._batchTextureCount<1&&(this._batchTextureCount=1);!c;)try{this._activeShader=this._fetchShaderProgram(b),c=!0}catch(d){if(1==this._batchTextureCount)throw"Cannot compile shader "+d;this._batchTextureCount-=4,this._batchTextureCount<1&&(this._batchTextureCount=1),this.vocalDebug&&console.log("Reducing desired texture count due to errors: "+this._batchTextureCount)}},b.updateViewport=function(a,b){this._viewportWidth=0|a,this._viewportHeight=0|b;var c=this._webGLContext;c&&(c.viewport(0,0,this._viewportWidth,this._viewportHeight),this._projectionMatrix=new Float32Array([2/this._viewportWidth,0,0,0,0,-2/this._viewportHeight,1,0,0,0,1,0,-1,1,.1,0]),this._projectionMatrixFlip=this._projectionMatrix.slice(),this._projectionMatrixFlip[5]*=-1,this._projectionMatrixFlip[13]*=-1)},b.getFilterShader=function(a,b){b||(b=this);var c=this._activeShader;if(b._builtShader)c=b._builtShader,c.shaderParamSetup&&c.shaderParamSetup(a,this,c);else try{c=this._fetchShaderProgram(a,"custom",b.VTX_SHADER_BODY,b.FRAG_SHADER_BODY,b.shaderParamSetup&&b.shaderParamSetup.bind(b)),b._builtShader=c}catch(d){console.log("SHADER SWITCH FAILURE",d)}return c},b.getBaseTexture=function(a,b,c){var d=a||1,e=b||1;void 0===c&&(c=new Uint8Array([.1,.2,.3,1]));var f=this._webGLContext,g=f.createTexture();return f.bindTexture(f.TEXTURE_2D,g),f.texImage2D(f.TEXTURE_2D,0,f.RGBA,d,e,0,f.RGBA,f.UNSIGNED_BYTE,c),this.setTextureParams(f),g},b.getRenderBufferTexture=function(a,b){var c=this._webGLContext,d=this.getBaseTexture(a,b,null);d.width=a,d.height=b;var e=c.createFramebuffer();return c.bindFramebuffer(c.FRAMEBUFFER,e),c.framebufferTexture2D(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.TEXTURE_2D,d,0),e._renderTexture=d,d._frameBuffer=e,d._storeID=-1,c.bindFramebuffer(c.FRAMEBUFFER,null),d},b.setTextureParams=function(a,b){a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.NEAREST),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.NEAREST),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE)},b.toString=function(){return"[SpriteStage (name="+this.name+")]"},b._fetchWebGLContext=function(a,b){var c;try{c=a.getContext("webgl",b)||a.getContext("experimental-webgl",b)}catch(d){}return c?(c.viewportWidth=a.width,c.viewportHeight=a.height):alert("Could not initialize WebGL"),c},b._fetchShaderProgram=function(b,c,d,e,f){b.useProgram(null);var g,h;switch(c){case"custom":h=a.COVER_VERTEX_HEADER,g=a.COVER_FRAGMENT_HEADER,h+=d||a.COVER_VERTEX_BODY,g+=e||a.COVER_FRAGMENT_BODY;break;case"particle":h=a.REGULAR_VERTEX_HEADER,g=a.REGULAR_FRAGMENT_HEADER,h+=a.PARTICLE_VERTEX_BODY,g+=a.PARTICLE_FRAGMENT_BODY;break;case"regular":default:h=a.REGULAR_VERTEX_HEADER,g=a.REGULAR_FRAGMENT_HEADER,h+=a.REGULAR_VERTEX_BODY,g+=a.REGULAR_FRAGMENT_BODY}var i=this._createShader(b,b.VERTEX_SHADER,h),j=this._createShader(b,b.FRAGMENT_SHADER,g),k=b.createProgram();if(b.attachShader(k,i),b.attachShader(k,j),b.linkProgram(k),!b.getProgramParameter(k,b.LINK_STATUS))throw b.useProgram(this._activeShader),b.getProgramInfoLog(k);switch(b.useProgram(k),c){case"custom":k.vertexPositionAttribute=b.getAttribLocation(k,"vertexPosition"),b.enableVertexAttribArray(k.vertexPositionAttribute),k.uvPositionAttribute=b.getAttribLocation(k,"uvPosition"),b.enableVertexAttribArray(k.uvPositionAttribute),k.samplerUniform=b.getUniformLocation(k,"uSampler"),b.uniform1i(k.samplerUniform,0),k.uprightUniform=b.getUniformLocation(k,"uUpright"),b.uniform1f(k.uprightUniform,0),f&&f(b,this,k);break;case"particle":case"regular":default:k.vertexPositionAttribute=b.getAttribLocation(k,"vertexPosition"),b.enableVertexAttribArray(k.vertexPositionAttribute),k.uvPositionAttribute=b.getAttribLocation(k,"uvPosition"),b.enableVertexAttribArray(k.uvPositionAttribute),k.textureIndexAttribute=b.getAttribLocation(k,"textureIndex"),b.enableVertexAttribArray(k.textureIndexAttribute),k.alphaAttribute=b.getAttribLocation(k,"objectAlpha"),b.enableVertexAttribArray(k.alphaAttribute);for(var l=[],m=0;m<this._batchTextureCount;m++)l[m]=m;k.samplerData=l,k.samplerUniform=b.getUniformLocation(k,"uSampler"),b.uniform1iv(k.samplerUniform,l),k.pMatrixUniform=b.getUniformLocation(k,"pMatrix")}return b.useProgram(this._activeShader),k},b._createShader=function(a,b,c){c=c.replace("{{count}}",this._batchTextureCount);for(var d="",e=1;e<this._batchTextureCount;e++)d+="} else if(src == "+e+") { color = texture2D(uSampler["+e+"], vTextureCoord);";c=c.replace("{{alternates}}",d);var f=a.createShader(b);if(a.shaderSource(f,c),a.compileShader(f),!a.getShaderParameter(f,a.COMPILE_STATUS))throw a.getShaderInfoLog(f);return f},b._createBuffers=function(b){var c,d,e=this._maxCardsPerBatch*a.INDICIES_PER_CARD,f=this._vertexPositionBuffer=b.createBuffer();b.bindBuffer(b.ARRAY_BUFFER,f),c=2;var g=this._vertices=new Float32Array(e*c);for(d=0;d<g.length;d+=c)g[d+0]=g[d+1]=0;b.bufferData(b.ARRAY_BUFFER,g,b.DYNAMIC_DRAW),f.itemSize=c,f.numItems=e;var h=this._uvPositionBuffer=b.createBuffer();b.bindBuffer(b.ARRAY_BUFFER,h),c=2;var i=this._uvs=new Float32Array(e*c);for(d=0;d<i.length;d+=c)i[d+0]=i[d+1]=0;b.bufferData(b.ARRAY_BUFFER,i,b.DYNAMIC_DRAW),h.itemSize=c,h.numItems=e;var j=this._textureIndexBuffer=b.createBuffer();b.bindBuffer(b.ARRAY_BUFFER,j),c=1;var k=this._indecies=new Float32Array(e*c);for(d=0;d<k.length;d++)k[d]=0;b.bufferData(b.ARRAY_BUFFER,k,b.DYNAMIC_DRAW),j.itemSize=c,j.numItems=e;var l=this._alphaBuffer=b.createBuffer();b.bindBuffer(b.ARRAY_BUFFER,l),c=1;var m=this._alphas=new Float32Array(e*c);for(d=0;d<m.length;d++)m[d]=1;b.bufferData(b.ARRAY_BUFFER,m,b.DYNAMIC_DRAW),l.itemSize=c,l.numItems=e},b._initTextures=function(){this._lastTextureInsert=-1,this._lastTextureID=-1,this._textureDictionary=[],this._textureIDs={},this._batchTextures=[];for(var a=0;a<this._batchTextureCount;a++)this._batchTextures[a]=this.getBaseTexture()},b._loadTextureImage=function(a,b){++this._lastTextureID;var c=b.src;c||(b._isCanvas=!0,c=b.src="canvas_"+this._lastTrackedCanvas++);var d=this._textureIDs[c];void 0===d&&(d=this._textureDictionary.length,this._textureIDs[c]=d),void 0===this._textureDictionary[d]&&(this._textureDictionary[d]=this.getBaseTexture());var e=this._textureDictionary[d];return e._batchID=this._batchID,e._storeID=d,e._imageData=b,this._insertTextureInBatch(a,e),b._storeID=d,b.complete||b.naturalWidth||b._isCanvas?this._updateTextureImageData(a,b):b.onload=this._updateTextureImageData.bind(this,a,b),e},b._updateTextureImageData=function(a,b){var c=this._textureDictionary[b._storeID];a.activeTexture(a.TEXTURE0+c._activeIndex),a.bindTexture(a.TEXTURE_2D,c),this.setTextureParams(a),a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,b),b._invalid=!1,c._w=b.width,c._h=b.height,this.vocalDebug&&((b.width&b.width-1||b.height&b.height-1)&&console.warn("NPOT(Non Power of Two) Texture: "+b.src),(b.width>a.MAX_TEXTURE_SIZE||b.height>a.MAX_TEXTURE_SIZE)&&console.error("Oversized Texture: "+b.width+"x"+b.height+" vs "+a.MAX_TEXTURE_SIZE+"max"))},b._insertTextureInBatch=function(a,b){if(this._batchTextures[b._activeIndex]!==b){var c=-1,d=(this._lastTextureInsert+1)%this._batchTextureCount,e=d;do{if(this._batchTextures[e]._batchID!=this._batchID&&!this._slotBlacklist[e]){c=e;break}e=(e+1)%this._batchTextureCount}while(e!==d);-1===c&&(this.batchReason="textureOverflow",this._drawBuffers(a),this.batchCardCount=0,c=d),this._batchTextures[c]=b,b._activeIndex=c;var f=b._imageData;f&&f._invalid&&void 0!==b._drawID?this._updateTextureImageData(a,f):(a.activeTexture(a.TEXTURE0+c),a.bindTexture(a.TEXTURE_2D,b),this.setTextureParams(a)),this._lastTextureInsert=c}else{var f=b._imageData;-1!=b._storeID&&f._invalid&&this._updateTextureImageData(a,f)}b._drawID=this._drawID,b._batchID=this._batchID},b._batchDraw=function(a,b,c){this._isDrawing>0&&this._drawBuffers(b),this._isDrawing++,this._drawID++,this.batchCardCount=0,this.depth=0;var d=new createjs.Matrix2D;this._appendToBatchGroup(a,b,d,this.alpha,c),this.batchReason="drawFinish",this._drawBuffers(b),this._isDrawing--},b._appendToBatchGroup=function(b,c,d,e,f){b._glMtx||(b._glMtx=new createjs.Matrix2D);var g=b._glMtx;g.copy(d),b.transformMatrix?g.appendMatrix(b.transformMatrix):g.appendTransform(b.x,b.y,b.scaleX,b.scaleY,b.rotation,b.skewX,b.skewY,b.regX,b.regY);for(var h,i,j,k,l=0,m=b.children.length;m>l;l++){var n=b.children[l];if(n.visible&&e)if(n.cacheCanvas&&!f||(3===n._webGLRenderStyle&&n._updateText(),!n.children)){this.batchCardCount+1>this._maxCardsPerBatch&&(this.batchReason="vertexOverflow",this._drawBuffers(c),this.batchCardCount=0),n._glMtx||(n._glMtx=new createjs.Matrix2D);var o=n._glMtx;o.copy(g),n.transformMatrix?o.appendMatrix(n.transformMatrix):o.appendTransform(n.x,n.y,n.scaleX,n.scaleY,n.rotation,n.skewX,n.skewY,n.regX,n.regY);var p,q,r,s,t,u=this._uvs,v=this._vertices,w=this._indecies,x=this._alphas;if(2===n._webGLRenderStyle||n.cacheCanvas&&!f)r=(f?!1:n.cacheCanvas)||n.image;else{if(1!==n._webGLRenderStyle)continue;s=n.spriteSheet.getFrame(n.currentFrame),r=s.image}if(r){if(void 0===r._storeID?(t=this._loadTextureImage(c,r),this._insertTextureInBatch(c,t)):(t=r._storeID<0?r:this._textureDictionary[r._storeID],t._batchID!==this._batchID&&this._insertTextureInBatch(c,t)),q=t._activeIndex,2===n._webGLRenderStyle||n.cacheCanvas&&!f)if(n.sourceRect){n._uvRect||(n._uvRect={});var y=n.sourceRect;p=n._uvRect,p.t=y.x/r.width,p.l=y.y/r.height,p.b=(y.x+y.width)/r.width,p.r=(y.y+y.height)/r.height,h=-n.regX,i=-n.regY,j=y.width+h,k=y.height+i}else n.cacheCanvas?(p=a.UV_RECT,h=n._cacheOffsetX,i=n._cacheOffsetY):(p=a.UV_RECT,h=-n.regX,i=-n.regY),j=r.width+h,k=r.height+i;else if(1===n._webGLRenderStyle){var z=s.rect;p=s.uvRect,p||(p=a.buildUVRects(n.spriteSheet,n.currentFrame,!1)),h=-s.regX,i=-s.regY,j=z.width-s.regX,k=z.height-s.regY}var A=this.batchCardCount*a.INDICIES_PER_CARD*2,B=A/2|0;v[A]=h*o.a+i*o.c+o.tx,v[A+1]=h*o.b+i*o.d+o.ty,v[A+2]=h*o.a+k*o.c+o.tx,v[A+3]=h*o.b+k*o.d+o.ty,v[A+4]=j*o.a+i*o.c+o.tx,v[A+5]=j*o.b+i*o.d+o.ty,v[A+6]=v[A+2],v[A+7]=v[A+3],v[A+8]=v[A+4],v[A+9]=v[A+5],v[A+10]=j*o.a+k*o.c+o.tx,v[A+11]=j*o.b+k*o.d+o.ty,u[A]=p.l,u[A+1]=p.t,u[A+2]=p.l,u[A+3]=p.b,u[A+4]=p.r,u[A+5]=p.t,u[A+6]=p.l,u[A+7]=p.b,u[A+8]=p.r,u[A+9]=p.t,u[A+10]=p.r,u[A+11]=p.b,w[B]=w[B+1]=w[B+2]=w[B+3]=w[B+4]=w[B+5]=q,x[B]=x[B+1]=x[B+2]=x[B+3]=x[B+4]=x[B+5]=n.alpha*e,this.batchCardCount++}}else this._appendToBatchGroup(n,c,g,n.alpha*e)}},b._drawBuffers=function(b){this.vocalDebug&&console.log("Draw["+this._drawID+":"+this._batchID+"] : "+this.batchReason);var c=this._activeShader,d=this._vertexPositionBuffer,e=this._textureIndexBuffer,f=this._uvPositionBuffer,g=this._alphaBuffer;b.useProgram(c),b.bindBuffer(b.ARRAY_BUFFER,d),b.vertexAttribPointer(c.vertexPositionAttribute,d.itemSize,b.FLOAT,!1,0,0),b.bufferSubData(b.ARRAY_BUFFER,0,this._vertices),b.bindBuffer(b.ARRAY_BUFFER,e),b.vertexAttribPointer(c.textureIndexAttribute,e.itemSize,b.FLOAT,!1,0,0),b.bufferSubData(b.ARRAY_BUFFER,0,this._indecies),b.bindBuffer(b.ARRAY_BUFFER,f),b.vertexAttribPointer(c.uvPositionAttribute,f.itemSize,b.FLOAT,!1,0,0),b.bufferSubData(b.ARRAY_BUFFER,0,this._uvs),b.bindBuffer(b.ARRAY_BUFFER,g),b.vertexAttribPointer(c.alphaAttribute,g.itemSize,b.FLOAT,!1,0,0),b.bufferSubData(b.ARRAY_BUFFER,0,this._alphas),b.uniformMatrix4fv(c.pMatrixUniform,b.FALSE,this._projectionMatrix);for(var h=0;h<this._batchTextureCount;h++){var i=this._batchTextures[h];b.activeTexture(b.TEXTURE0+h),b.bindTexture(b.TEXTURE_2D,i),this.setTextureParams(b)}b.drawArrays(b.TRIANGLES,0,this.batchCardCount*a.INDICIES_PER_CARD),this._batchID++},b._drawCover=function(b,c){this._isDrawing>0&&this._drawBuffers(b),this.vocalDebug&&console.log("Draw["+this._drawID+":"+this._batchID+"] : Cover");var d=this._activeShader,e=this._vertexPositionBuffer,f=this._uvPositionBuffer;b.clear(b.COLOR_BUFFER_BIT),b.useProgram(d),b.bindBuffer(b.ARRAY_BUFFER,e),b.vertexAttribPointer(d.vertexPositionAttribute,e.itemSize,b.FLOAT,!1,0,0),b.bufferSubData(b.ARRAY_BUFFER,0,a.COVER_VERT),b.bindBuffer(b.ARRAY_BUFFER,f),b.vertexAttribPointer(d.uvPositionAttribute,f.itemSize,b.FLOAT,!1,0,0),b.bufferSubData(b.ARRAY_BUFFER,0,c?a.COVER_UV_FLIP:a.COVER_UV),b.uniform1i(d.samplerUniform,0),b.uniform1f(d.uprightUniform,c?0:1),b.drawArrays(b.TRIANGLES,0,a.INDICIES_PER_CARD)},function(){var a=[createjs.Sprite,createjs.Bitmap,createjs.BitmapText];a.forEach(function(a,b){a.prototype._webGLRenderStyle=b+1});var b=createjs.CacheManager.prototype;b._createSurfaceBASE=b._createSurface,b._createSurface=function(a){return a?void(this._webGLCache!==a&&(a===!0?(this.cacheCanvas=document.createElement("canvas"),this._webGLCache=new createjs.SpriteStage(this.cacheCanvas),this._webGLCache.isCacheControlled=!0):(this.cacheCanvas=!0,this._webGLCache=a))):void this._createSurfaceBASE()},b._drawToCacheBASE=b._drawToCache,b._drawToCache=function(a,b,c){var d=this.cacheCanvas,e=this.target,f=this._webGLCache;return f?(f.isCacheControlled&&(b!=d.width||c!=d.height)&&(d.width=b,d.height=c,f.updateViewport(b,c)),this._webGLCache.cacheDraw(e,e.filters),void(this.cacheCanvas=e.cacheCanvas)):void this._drawToCacheBASE(a,b,c)},b.uncacheBASE=b.uncache,b.uncache=function(){this._webGLCache&&(this._webGLCache.isCacheControlled||this._webGLCache.unregisterTexture(this.cacheCanvas),this._webGLCache=!1),this.uncacheBASE()}}(),createjs.SpriteStage=createjs.promote(a,"Stage")}();